def initialize_google_sheets():
    """Initialize Google Sheets connection using service account."""
    try:
        logger.info("Initializing Google Sheets connection...")

        # Verify required credentials exist
        required_fields = [
            'type', 'project_id', 'private_key_id', 'private_key',
            'client_email', 'client_id', 'auth_uri', 'token_uri',
            'auth_provider_x509_cert_url', 'client_x509_cert_url'
        ]

        credentials_info = {}
        missing_fields = []

        # Check each required field in st.secrets
        for field in required_fields:
            try:
                value = st.secrets[field]
                if not value:
                    missing_fields.append(field)
                credentials_info[field] = value
            except KeyError:
                missing_fields.append(field)

        if missing_fields:
            error_msg = f"Missing required Google credentials: {', '.join(missing_fields)}"
            logger.error(error_msg)
            st.error(f"Google Sheets connection failed: {error_msg}")
            return None

        # Create credentials object
        try:
            credentials = service_account.Credentials.from_service_account_info(
                credentials_info,
                scopes=[
                    "https://www.googleapis.com/auth/spreadsheets",
                    "https://www.googleapis.com/auth/drive"
                ],
            )
        except Exception as e:
            error_msg = f"Invalid credentials format: {str(e)}"
            logger.error(error_msg)
            st.error(f"Google Sheets connection failed: {error_msg}")
            return None

        # Initialize client
        try:
            client = gspread.authorize(credentials)
            # Test connection by trying to open a dummy spreadsheet
            client.open_by_key("1OuiQ3FEoNAtH10NllgLusxACjn2NU0yZUcHh68hLoI4")
            logger.info("Google Sheets connection initialized successfully")
            return client
        except Exception as e:
            error_msg = f"Failed to authorize with Google: {str(e)}"
            logger.error(error_msg)
            st.error(f"Google Sheets connection failed: {error_msg}")
            return None

    except Exception as e:
        error_msg = f"Unexpected error initializing Google Sheets: {str(e)}"
        logger.error(error_msg)
        st.error(f"Google Sheets connection failed: {error_msg}")
        return None